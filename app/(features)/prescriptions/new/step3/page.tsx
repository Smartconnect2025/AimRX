"use client";

import { useRouter, useSearchParams } from "next/navigation";
import { useEffect, useState } from "react";
import DefaultLayout from "@/components/layout/DefaultLayout";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { ArrowLeft, CheckCircle2, Loader2, File, MapPin, Pencil, X } from "lucide-react";
import { toast } from "sonner";
import { createClient } from "@core/supabase";
import { useUser } from "@core/auth";
import {
  getProviderTierDiscount,
  type TierDiscountResult,
} from "@core/services/pricing/tierDiscountService";

interface PrescriptionFormData {
  medication: string;
  strength: string;
  dosageAmount?: string;
  dosageUnit?: string;
  vialSize?: string;
  form: string;
  quantity: string;
  refills: string;
  sig: string;
  dispenseAsWritten: boolean;
  pharmacyNotes: string;
  patientPrice?: string;
  doctorPrice?: string;
  selectedPharmacyId?: string;
  selectedPharmacyName?: string;
  selectedPharmacyColor?: string;
  selectedMedicationId?: string;
  oversightFees?: Array<{ fee: string; reason: string }>;
  shippingFee?: string;
}

interface AddressData {
  street?: string;
  city?: string;
  state?: string;
  zipCode?: string;
  country?: string;
}

interface PatientData {
  id: string;
  firstName: string;
  lastName: string;
  dateOfBirth?: string;
  email?: string;
  phone?: string;
  physicalAddress?: AddressData;
}

export default function PrescriptionStep3Page() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const patientId = searchParams.get("patientId");
  const [prescriptionData, setPrescriptionData] =
    useState<PrescriptionFormData | null>(null);
  const [submitting, setSubmitting] = useState(false);
  const [selectedPatient, setSelectedPatient] = useState<PatientData | null>(
    null,
  );
  const [loadingPatient, setLoadingPatient] = useState(true);
  const [pdfInfo, setPdfInfo] = useState<{
    name: string;
    dataUrl: string;
  } | null>(null);
  const [tierDiscount, setTierDiscount] = useState<TierDiscountResult | null>(
    null,
  );
  const [useCustomAddress, setUseCustomAddress] = useState(false);
  const [showAddressForm, setShowAddressForm] = useState(false);
  const [customAddress, setCustomAddress] = useState<AddressData>({
    street: "",
    city: "",
    state: "",
    zipCode: "",
    country: "US",
  });
  const supabase = createClient();
  const { user } = useUser();

  // Fetch patient directly from database to avoid race conditions
  useEffect(() => {
    const fetchPatient = async () => {
      if (!patientId) {
        setLoadingPatient(false);
        return;
      }

      try {
        const { data: patient, error } = await supabase
          .from("patients")
          .select("*")
          .eq("id", patientId)
          .single();

        if (error) {
          console.error("Error fetching patient:", error);
          toast.error("Failed to load patient information");
        } else {
          const addr = patient.physical_address as AddressData | null;
          setSelectedPatient({
            id: patient.id,
            firstName: patient.first_name,
            lastName: patient.last_name,
            dateOfBirth: patient.date_of_birth,
            email: patient.email,
            phone: patient.phone,
            physicalAddress: addr || undefined,
          });
        }
      } catch (error) {
        console.error("Error fetching patient:", error);
        toast.error("Failed to load patient information");
      } finally {
        setLoadingPatient(false);
      }
    };

    fetchPatient();
  }, [patientId, supabase]);

  // Fetch provider's tier discount
  useEffect(() => {
    const fetchTierDiscount = async () => {
      if (!user?.id) return;

      const result = await getProviderTierDiscount(supabase, user.id);
      if (result.discountPercentage > 0) {
        setTierDiscount(result);
      }
    };

    fetchTierDiscount();
  }, [user?.id, supabase]);

  useEffect(() => {
    // ALWAYS read from prescriptionFormData (the fresh data from Step 2)
    const data = sessionStorage.getItem("prescriptionFormData");

    if (!data) {
      router.push("/prescriptions/new/step1?error=session_expired");
      return;
    }

    const loadedData = JSON.parse(data);

    setPrescriptionData(loadedData);

    // Load PDF info from sessionStorage
    const pdfData = sessionStorage.getItem("prescriptionPdfData");
    const pdfName = sessionStorage.getItem("prescriptionPdfName");
    if (pdfData && pdfName) {
      setPdfInfo({ name: pdfName, dataUrl: pdfData });
    }
  }, [router]);

  // Clean up prescription state when unmounting (navigating away)
  useEffect(() => {
    return () => {
      // Only clear if navigating away from prescription wizard (not to success page)
      const pathname = window.location.pathname;
      const isStillInWizard = pathname.startsWith("/prescriptions/new/");
      if (!isStillInWizard) {
        sessionStorage.removeItem("prescriptionData");
        sessionStorage.removeItem("prescriptionDraft");
        sessionStorage.removeItem("selectedPatientId");
        sessionStorage.removeItem("encounterId");
        sessionStorage.removeItem("appointmentId");
        sessionStorage.removeItem("prescriptionPdfData");
        sessionStorage.removeItem("prescriptionPdfName");
      }
    };
  }, []);

  if (!patientId) {
    return (
      <DefaultLayout>
        <div className="container mx-auto max-w-5xl py-8 px-4">
          <div className="text-center">
            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              No patient selected
            </h2>
            <Button onClick={() => router.push("/prescriptions/new/step1")}>
              Go Back to Step 1
            </Button>
          </div>
        </div>
      </DefaultLayout>
    );
  }

  if (loadingPatient || !selectedPatient) {
    return (
      <DefaultLayout>
        <div className="container mx-auto max-w-5xl py-8 px-4">
          <div className="text-center py-12">
            <Loader2 className="h-8 w-8 animate-spin mx-auto mb-4 text-primary" />
            <p className="text-muted-foreground">
              Loading patient information...
            </p>
          </div>
        </div>
      </DefaultLayout>
    );
  }

  if (!prescriptionData) {
    return (
      <DefaultLayout>
        <div className="container mx-auto max-w-5xl py-8 px-4">
          <div className="text-center">
            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              No prescription data found
            </h2>
            <Button
              onClick={() =>
                router.push("/prescriptions/new/step2?patientId=" + patientId)
              }
            >
              Go Back to Step 2
            </Button>
          </div>
        </div>
      </DefaultLayout>
    );
  }

  const handleBack = () => {
    router.push(`/prescriptions/new/step2?patientId=${patientId}`);
  };

  const handleSubmit = async () => {
    setSubmitting(true);

    try {
      if (!user || !patientId || !selectedPatient) {
        throw new Error("Missing user or patient information");
      }

      // Ensure patient data is fully loaded before submitting
      if (!selectedPatient.firstName || !selectedPatient.lastName) {
        throw new Error("Patient information is incomplete. Please try again.");
      }

      // Get encounter/appointment context from session storage
      const encounterId = sessionStorage.getItem("encounterId");
      const appointmentId = sessionStorage.getItem("appointmentId");

      // Get provider info from providers table
      const { data: providerData, error: providerError } = await supabase
        .from("providers")
        .select("first_name, last_name")
        .eq("user_id", user.id)
        .single();

      // Use provider data or fallback to default values
      const providerFirstName = providerData?.first_name || "Provider";
      const providerLastName = providerData?.last_name || "User";

      // Calculate total oversight fees in cents
      const totalOversightFeesCents = prescriptionData.oversightFees
        ? prescriptionData.oversightFees.reduce((sum, item) => {
            const feeValue = parseFloat(item.fee) || 0;
            return sum + feeValue * 100; // Convert dollars to cents
          }, 0)
        : 0;

      // Prepare payload for real DigitalRx API
      const submissionPayload = {
        prescriber_id: user.id,
        patient_id: patientId,
        encounter_id: encounterId || null,
        appointment_id: appointmentId || null,
        medication: prescriptionData.medication,
        dosage: prescriptionData.strength,
        dosage_amount: prescriptionData.dosageAmount || null,
        dosage_unit: prescriptionData.dosageUnit || null,
        vial_size: prescriptionData.vialSize || null,
        form: prescriptionData.form || null,
        quantity: parseInt(prescriptionData.quantity),
        refills: parseInt(prescriptionData.refills),
        sig: prescriptionData.sig,
        dispense_as_written: prescriptionData.dispenseAsWritten || false,
        pharmacy_notes: prescriptionData.pharmacyNotes || null,
        patient_price: prescriptionData.patientPrice || null,
        doctor_price: prescriptionData.doctorPrice || null,
        pharmacy_id: prescriptionData.selectedPharmacyId || null,
        medication_id: prescriptionData.selectedMedicationId || null,
        profit_cents: totalOversightFeesCents, // Provider oversight/monitoring fees
        shipping_fee_cents: Math.round(
          parseFloat(prescriptionData.shippingFee || "0") * 100,
        ),
        has_custom_address: useCustomAddress,
        custom_address: useCustomAddress ? customAddress : null,
        patient: {
          first_name: selectedPatient.firstName,
          last_name: selectedPatient.lastName,
          date_of_birth: selectedPatient.dateOfBirth || "1990-01-01",
          phone: selectedPatient.phone || "",
          email: selectedPatient.email || "",
        },
        prescriber: {
          first_name: providerFirstName,
          last_name: providerLastName,
          npi: "1234567890", // Sandbox default
          dea: "AB1234563", // Sandbox default
        },
      };

      // Submit to real DigitalRx API
      const response = await fetch("/api/prescriptions/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(submissionPayload),
      });

      const result = await response.json().catch(() => ({}));

      // Check if submission was successful
      if (!response.ok || !result.success) {
        // Only throw error if there's actual error content
        throw new Error(result.error || "Failed to submit prescription");
      }

      const prescriptionId = result.prescription_id;

      // Upload PDF if present
      if (pdfInfo && prescriptionId) {
        try {
          // Convert data URL back to Blob using base64 decoding (more reliable than fetch)
          // Parse the data URL
          const dataUrlParts = pdfInfo.dataUrl.split(",");
          if (dataUrlParts.length !== 2) {
            throw new Error("Invalid data URL format");
          }

          const mimeMatch = dataUrlParts[0].match(/:(.*?);/);
          const mimeType = mimeMatch ? mimeMatch[1] : "application/pdf";
          const base64Data = dataUrlParts[1];

          // Decode base64 to binary
          const binaryString = atob(base64Data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }

          const blob = new Blob([bytes], { type: mimeType });

          const formData = new FormData();
          formData.append("file", blob, pdfInfo.name);

          const uploadResponse = await fetch(
            `/api/prescriptions/${prescriptionId}/pdf`,
            {
              method: "POST",
              body: formData,
            },
          );

          const pdfResult = await uploadResponse.json();

          if (!pdfResult.success) {
            console.error("❌ [Step3] PDF upload failed:", pdfResult.error);
            // Don't fail the whole submission, just warn
            toast.warning("Prescription created but PDF upload failed", {
              description: pdfResult.error,
              duration: 5000,
            });
          }
        } catch (pdfError) {
          console.error("❌ [Step3] Error uploading PDF:", pdfError);
          toast.warning("Prescription created but PDF upload failed");
        }
      }

      // Big success toast with demo mode indicator
      toast.success("Prescription submitted successfully!", {
        duration: 6000,
        icon: <CheckCircle2 className="h-5 w-5" />,
      });

      // Clear ALL session storage
      sessionStorage.removeItem("prescriptionData");
      sessionStorage.removeItem("prescriptionFormData");
      sessionStorage.removeItem("selectedPatientId");
      sessionStorage.removeItem("prescriptionDraft");
      sessionStorage.removeItem("encounterId");
      sessionStorage.removeItem("appointmentId");
      sessionStorage.removeItem("prescriptionPdfData");
      sessionStorage.removeItem("prescriptionPdfName");

      setSubmitting(false);

      // Redirect to prescriptions list with refresh flag
      router.push("/prescriptions?refresh=true");
    } catch (error) {
      setSubmitting(false);
      const errorMessage =
        error instanceof Error
          ? error.message
          : "Failed to submit prescription";

      // Big error toast with exact error message
      toast.error("Submission failed", {
        description: errorMessage,
        duration: 6000,
      });
      console.error("Submission error:", error);
    }
  };

  return (
    <DefaultLayout>
      {/* Full-page loading overlay */}
      {submitting && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
          <div className="bg-white rounded-lg p-8 shadow-2xl flex flex-col items-center gap-4">
            <Loader2 className="h-12 w-12 animate-spin text-primary" />
            <p className="text-lg font-semibold text-foreground">
              Submitting prescription to pharmacy...
            </p>
            <p className="text-sm text-muted-foreground">
              Please wait while we process your request
            </p>
          </div>
        </div>
      )}

      <div className="container max-w-7xl mx-auto py-8 px-4">
        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-2xl sm:text-3xl font-bold tracking-tight">
                New Prescription
              </h1>
              <p className="text-muted-foreground mt-2">
                Step 3 of 3: Review & Submit
              </p>
            </div>
            <Button
              variant="outline"
              onClick={() => router.push("/")}
              disabled={submitting}
            >
              Cancel
            </Button>
          </div>

          {/* Progress indicator */}
          <div className="flex items-center gap-2 mt-6">
            <div className="flex items-center">
              <div className="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-semibold">
                ✓
              </div>
              <span className="ml-2 text-sm text-muted-foreground">
                Select Patient
              </span>
            </div>
            <div className="w-12 h-0.5 bg-green-500"></div>
            <div className="flex items-center">
              <div className="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-semibold">
                ✓
              </div>
              <span className="ml-2 text-sm text-muted-foreground">
                Prescription Details
              </span>
            </div>
            <div className="w-12 h-0.5 bg-primary"></div>
            <div className="flex items-center">
              <div className="w-8 h-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-semibold">
                3
              </div>
              <span className="ml-2 font-medium">Review & Submit</span>
            </div>
          </div>
        </div>

        {/* Review Content */}
        <div className="bg-white border border-border rounded-lg p-6 space-y-6">
          <div className="flex items-center gap-2 pb-4 border-b">
            <CheckCircle2 className="h-5 w-5 text-green-600" />
            <h2 className="text-xl font-semibold">Review Prescription</h2>
          </div>

          {/* Patient Information */}
          <div className="space-y-3">
            <h3 className="text-lg font-semibold text-gray-900">
              Patient Information
            </h3>
            <div className="bg-gray-50 rounded-lg p-4 space-y-2">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-muted-foreground">Name</p>
                  <p className="font-medium">
                    {selectedPatient
                      ? `${selectedPatient.firstName} ${selectedPatient.lastName}`
                      : "Loading..."}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">Date of Birth</p>
                  <p className="font-medium">
                    {selectedPatient?.dateOfBirth
                      ? new Date(
                          selectedPatient.dateOfBirth,
                        ).toLocaleDateString()
                      : "N/A"}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">Email</p>
                  <p className="font-medium">
                    {selectedPatient?.email || "N/A"}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">Phone</p>
                  <p className="font-medium">
                    {selectedPatient?.phone || "N/A"}
                  </p>
                </div>
                <div className="col-span-2">
                  <p className="text-sm text-muted-foreground">Address</p>
                  {(() => {
                    const addr = useCustomAddress ? customAddress : selectedPatient?.physicalAddress;
                    if (addr && (addr.street || addr.city)) {
                      return (
                        <div className="flex items-start gap-2">
                          <MapPin className="h-4 w-4 text-gray-400 mt-0.5 shrink-0" />
                          <p className="font-medium">
                            {[addr.street, addr.city, addr.state, addr.zipCode]
                              .filter(Boolean)
                              .join(", ")}
                          </p>
                        </div>
                      );
                    }
                    return <p className="font-medium text-amber-600">No address on file</p>;
                  })()}
                  {useCustomAddress && (
                    <span className="inline-block mt-1 px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded">
                      Custom address for this prescription
                    </span>
                  )}
                </div>
              </div>

              {/* Override Address Button / Form */}
              {!showAddressForm ? (
                <div className="pt-2 border-t border-gray-200 mt-3">
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => {
                      // Pre-fill with patient address if available
                      if (!useCustomAddress && selectedPatient?.physicalAddress) {
                        setCustomAddress({
                          street: selectedPatient.physicalAddress.street || "",
                          city: selectedPatient.physicalAddress.city || "",
                          state: selectedPatient.physicalAddress.state || "",
                          zipCode: selectedPatient.physicalAddress.zipCode || "",
                          country: selectedPatient.physicalAddress.country || "US",
                        });
                      }
                      setShowAddressForm(true);
                    }}
                  >
                    <Pencil className="mr-2 h-3.5 w-3.5" />
                    {useCustomAddress ? "Edit Override Address" : "Override Address for This Prescription"}
                  </Button>
                  {useCustomAddress && (
                    <Button
                      type="button"
                      variant="ghost"
                      size="sm"
                      className="ml-2 text-red-600 hover:text-red-700 hover:bg-red-50"
                      onClick={() => {
                        setUseCustomAddress(false);
                        setCustomAddress({ street: "", city: "", state: "", zipCode: "", country: "US" });
                      }}
                    >
                      <X className="mr-1 h-3.5 w-3.5" />
                      Remove Override
                    </Button>
                  )}
                </div>
              ) : (
                <div className="pt-3 border-t border-gray-200 mt-3 space-y-3">
                  <div className="flex items-center justify-between">
                    <h4 className="text-sm font-semibold text-gray-900">
                      Override Shipping Address
                    </h4>
                    <Button
                      type="button"
                      variant="ghost"
                      size="sm"
                      onClick={() => setShowAddressForm(false)}
                    >
                      <X className="h-4 w-4" />
                    </Button>
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="override-street">Street Address</Label>
                    <Input
                      id="override-street"
                      placeholder="123 Main St"
                      value={customAddress.street || ""}
                      onChange={(e) => setCustomAddress((prev) => ({ ...prev, street: e.target.value }))}
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div className="space-y-2">
                      <Label htmlFor="override-city">City</Label>
                      <Input
                        id="override-city"
                        placeholder="City"
                        value={customAddress.city || ""}
                        onChange={(e) => setCustomAddress((prev) => ({ ...prev, city: e.target.value }))}
                      />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="override-state">State</Label>
                      <Input
                        id="override-state"
                        placeholder="FL"
                        value={customAddress.state || ""}
                        onChange={(e) => setCustomAddress((prev) => ({ ...prev, state: e.target.value }))}
                      />
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div className="space-y-2">
                      <Label htmlFor="override-zip">Zip Code</Label>
                      <Input
                        id="override-zip"
                        placeholder="33101"
                        value={customAddress.zipCode || ""}
                        onChange={(e) => setCustomAddress((prev) => ({ ...prev, zipCode: e.target.value }))}
                      />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="override-country">Country</Label>
                      <Input
                        id="override-country"
                        placeholder="US"
                        value={customAddress.country || ""}
                        onChange={(e) => setCustomAddress((prev) => ({ ...prev, country: e.target.value }))}
                      />
                    </div>
                  </div>
                  <div className="flex gap-2 pt-1">
                    <Button
                      type="button"
                      size="sm"
                      onClick={() => {
                        setUseCustomAddress(true);
                        setShowAddressForm(false);
                      }}
                      disabled={!customAddress.street?.trim() || !customAddress.city?.trim()}
                    >
                      <CheckCircle2 className="mr-1.5 h-3.5 w-3.5" />
                      Save Override
                    </Button>
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={() => setShowAddressForm(false)}
                    >
                      Cancel
                    </Button>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Prescription Document */}
          {pdfInfo && (
            <div className="space-y-3">
              <h3 className="text-lg font-semibold text-gray-900">
                Prescription Document
              </h3>
              <div className="flex items-center gap-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div className="p-3 bg-blue-100 rounded-lg">
                  <File className="h-6 w-6 text-blue-600" />
                </div>
                <div>
                  <p className="font-medium text-gray-900">{pdfInfo.name}</p>
                  <p className="text-sm text-gray-500">PDF document attached</p>
                </div>
              </div>
            </div>
          )}

          {/* Medication Information */}
          <div className="space-y-3">
            <h3 className="text-lg font-semibold text-gray-900">
              Medication Information
            </h3>
            <div className="bg-blue-50 rounded-lg p-4 space-y-3">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-muted-foreground">Medication</p>
                  <p className="font-semibold text-lg">
                    {prescriptionData.medication}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">
                    Strength/Dosage
                  </p>
                  <p className="font-medium">{prescriptionData.strength}</p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">Form</p>
                  <p className="font-medium">
                    {prescriptionData.form || "N/A"}
                  </p>
                </div>
                {prescriptionData.vialSize && (
                  <div>
                    <p className="text-sm text-muted-foreground">Vial Size</p>
                    <p className="font-medium">{prescriptionData.vialSize}</p>
                  </div>
                )}
                <div>
                  <p className="text-sm text-muted-foreground">Quantity</p>
                  <p className="font-medium">{prescriptionData.quantity}</p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">Refills</p>
                  <p className="font-medium">{prescriptionData.refills}</p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">
                    Dispense as Written
                  </p>
                  <p className="font-medium">
                    {prescriptionData.dispenseAsWritten ? "Yes" : "No"}
                  </p>
                </div>
                {prescriptionData.selectedPharmacyName && (
                  <div className="col-span-2">
                    <p className="text-sm text-muted-foreground">Pharmacy</p>
                    <p
                      className="font-semibold text-lg"
                      style={{
                        color:
                          prescriptionData.selectedPharmacyColor || "#1E3A8A",
                      }}
                    >
                      {prescriptionData.selectedPharmacyName}
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Directions */}
          <div className="space-y-3">
            <h3 className="text-lg font-semibold text-gray-900">
              Directions for Patient (SIG)
            </h3>
            <div className="bg-gray-50 rounded-lg p-4">
              <p className="text-gray-900">{prescriptionData.sig}</p>
            </div>
          </div>

          {/* Pharmacy Notes */}
          {prescriptionData.pharmacyNotes && (
            <div className="space-y-3">
              <h3 className="text-lg font-semibold text-gray-900">
                Notes to Pharmacy
              </h3>
              <div className="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                <p className="text-gray-900 whitespace-pre-wrap">
                  {prescriptionData.pharmacyNotes}
                </p>
              </div>
            </div>
          )}

          {/* Pricing Information */}
          {prescriptionData.patientPrice && (
            <div className="space-y-3">
              <h3 className="text-lg font-semibold text-gray-900">
                Price of Medication
              </h3>
              <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                <p className="text-2xl font-bold text-green-700">
                  ${parseFloat(prescriptionData.patientPrice).toFixed(2)}
                </p>
              </div>
              {tierDiscount && tierDiscount.discountPercentage > 0 && (
                <div className="bg-blue-50 rounded-lg px-4 py-3 border border-blue-200">
                  <p className="text-sm text-blue-800">
                    A {tierDiscount.discountPercentage}% discount has been
                    applied based on your ({tierDiscount.tierName}) pricing
                    tier.
                  </p>
                </div>
              )}
            </div>
          )}

          {/* Oversight Fees */}
          {((prescriptionData.oversightFees &&
            prescriptionData.oversightFees.length > 0) ||
            (prescriptionData.shippingFee &&
              parseFloat(prescriptionData.shippingFee) > 0)) && (
            <div className="space-y-3">
              <h3 className="text-lg font-semibold text-gray-900">
                Medication Oversight & Monitoring Fees
              </h3>
              <div className="space-y-3">
                {/* Shipping Fee */}
                {prescriptionData.shippingFee &&
                  parseFloat(prescriptionData.shippingFee) > 0 && (
                    <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                      <div className="flex justify-between items-center">
                        <p className="font-medium text-gray-900">
                          Shipping and Handling
                        </p>
                        <p className="text-xl font-bold text-blue-700">
                          ${parseFloat(prescriptionData.shippingFee).toFixed(2)}
                        </p>
                      </div>
                    </div>
                  )}

                {prescriptionData.oversightFees?.map((item, index) => {
                  const reasonLabels: Record<string, string> = {
                    dose_titration: "Dose Titration & Adjustment",
                    side_effect_monitoring: "Side Effect & Safety Monitoring",
                    therapeutic_response: "Therapeutic Response Review",
                    adherence_tracking: "Medication Adherence Tracking",
                    contraindication_screening: "Contraindication Screening",
                  };

                  return (
                    <div
                      key={index}
                      className="bg-blue-50 rounded-lg p-4 border border-blue-200"
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <p className="text-sm text-muted-foreground">
                            Reason
                          </p>
                          <p className="font-medium text-gray-900">
                            {reasonLabels[item.reason] || item.reason}
                          </p>
                        </div>
                        <div className="text-right">
                          <p className="text-sm text-muted-foreground">
                            Fee Amount
                          </p>
                          <p className="text-xl font-bold text-blue-700">
                            ${parseFloat(item.fee).toFixed(2)}
                          </p>
                        </div>
                      </div>
                    </div>
                  );
                })}
                <div className="bg-blue-100 rounded-lg p-4 border-2 border-blue-300">
                  <div className="flex justify-between items-center">
                    <p className="font-semibold text-gray-900">
                      Total Oversight Fees
                    </p>
                    <p className="text-2xl font-bold text-blue-700">
                      $
                      {(
                        (prescriptionData.oversightFees?.reduce(
                          (sum, item) => sum + parseFloat(item.fee || "0"),
                          0,
                        ) || 0) +
                        parseFloat(prescriptionData.shippingFee || "0")
                      ).toFixed(2)}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Total Patient Cost */}
          {(prescriptionData.patientPrice ||
            (prescriptionData.oversightFees &&
              prescriptionData.oversightFees.length > 0) ||
            (prescriptionData.shippingFee &&
              parseFloat(prescriptionData.shippingFee) > 0)) && (
            <div className="space-y-3">
              <div className="bg-gradient-to-r from-green-100 to-blue-100 rounded-lg p-6 border-2 border-green-300">
                <div className="flex justify-between items-center">
                  <h3 className="text-xl font-bold text-gray-900">
                    Total Patient Cost
                  </h3>
                  <p className="text-3xl font-bold text-gray-900">
                    $
                    {(
                      parseFloat(prescriptionData.patientPrice || "0") +
                      (prescriptionData.oversightFees?.reduce(
                        (sum, item) => sum + parseFloat(item.fee || "0"),
                        0,
                      ) || 0) +
                      parseFloat(prescriptionData.shippingFee || "0")
                    ).toFixed(2)}
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Action Buttons */}
          <div className="flex justify-between pt-6 border-t">
            <Button
              variant="outline"
              onClick={handleBack}
              disabled={submitting}
            >
              <ArrowLeft className="mr-2 h-4 w-4" />
              Back to Edit
            </Button>
            <Button
              onClick={handleSubmit}
              size="lg"
              disabled={submitting}
              className="bg-blue-600 hover:bg-blue-700 text-white font-bold"
            >
              {submitting ? (
                <>
                  <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                  Processing...
                </>
              ) : (
                <>
                  <CheckCircle2 className="mr-2 h-5 w-5" />
                  Prescribe
                </>
              )}
            </Button>
          </div>
        </div>
      </div>
    </DefaultLayout>
  );
}
