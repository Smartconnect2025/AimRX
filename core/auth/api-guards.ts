/**
 * API Route Guards
 *
 * Provides server-side validation utilities for API routes to ensure
 * users have completed required steps (authentication, intake, etc.)
 * before accessing protected resources.
 */
import { createServerClient } from "@core/supabase";
import { getUserRole } from "./auth-utils";
import { User } from "@supabase/supabase-js";

export interface ApiAuthInfo {
  user: User | null;
  userRole: string | null;
}

export interface ApiGuardResult {
  success: boolean;
  error?: string;
  status?: number;
  authInfo?: ApiAuthInfo;
}

/**
 * Validates that the user is authenticated
 * Use this for API routes that require authentication
 *
 * @returns ApiGuardResult with validation status and user info
 */
export async function requireAuthentication(): Promise<ApiGuardResult> {
  try {
    const supabase = await createServerClient();

    // Get the authenticated user
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      return {
        success: false,
        error: "Authentication required",
        status: 401,
      };
    }

    // Get user role
    const userRole = await getUserRole(user.id, supabase);

    return {
      success: true,
      authInfo: {
        user,
        userRole,
      },
    };
  } catch (error) {
    console.error("Error in requireAuthentication guard:", error);
    return {
      success: false,
      error: "Internal server error",
      status: 500,
    };
  }
}

/**
 * Validates that the user has a specific role
 *
 * @param requiredRole - The role required to access the resource
 * @returns ApiGuardResult with validation status and user info
 */
export async function requireRole(
  requiredRole: string,
): Promise<ApiGuardResult> {
  const authResult = await requireAuthentication();

  if (!authResult.success) {
    return authResult;
  }

  const { authInfo } = authResult;

  if (authInfo?.userRole !== requiredRole) {
    return {
      success: false,
      error: `Access denied. Required role: ${requiredRole}`,
      status: 403,
      authInfo,
    };
  }

  return authResult;
}

/**
 * Helper function to create standardized error responses for API routes
 *
 * @param result - The result from an API guard function
 * @returns Response object with appropriate status and error message
 */
export function createGuardErrorResponse(result: ApiGuardResult): Response {
  return new Response(
    JSON.stringify({
      error: result.error,
    }),
    {
      status: result.status || 500,
      headers: { "Content-Type": "application/json" },
    },
  );
}
